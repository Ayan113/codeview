// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  avatar        String?
  role          String    @default("USER") // USER, ADMIN, INTERVIEWER
  isActive      Boolean   @default(true)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  createdInterviews Interview[]   @relation("InterviewCreator")
  participations    InterviewParticipant[]
  questionsCreated  Question[]
  submissions       Submission[]
  notes             InterviewNote[]
  sessions          Session[]

  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  userAgent    String?
  ipAddress    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============================================
// INTERVIEW MANAGEMENT
// ============================================

model Interview {
  id              String   @id @default(cuid())
  title           String
  description     String?
  scheduledAt     DateTime?
  duration        Int      @default(60) // in minutes
  status          String   @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  roomCode        String   @unique @default(cuid())
  startedAt       DateTime?
  endedAt         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Creator
  creatorId       String
  creator         User     @relation("InterviewCreator", fields: [creatorId], references: [id])
  
  // Relations
  participants    InterviewParticipant[]
  questions       InterviewQuestion[]
  submissions     Submission[]
  notes           InterviewNote[]
  codeSnapshots   CodeSnapshot[]

  @@index([roomCode])
  @@index([creatorId])
  @@index([scheduledAt])
}

model InterviewParticipant {
  id            String   @id @default(cuid())
  interviewId   String
  userId        String
  role          String   // HOST, CANDIDATE, OBSERVER
  joinedAt      DateTime?
  leftAt        DateTime?
  isOnline      Boolean  @default(false)
  
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id])

  @@unique([interviewId, userId])
  @@index([interviewId])
  @@index([userId])
}

// ============================================
// QUESTION BANK
// ============================================

model Question {
  id           String   @id @default(cuid())
  title        String
  description  String
  difficulty   String   // EASY, MEDIUM, HARD
  category     String
  tags         Json     @default("[]")
  starterCode  Json     @default("{}")
  testCases    Json     @default("[]")
  solution     String?
  hints        Json     @default("[]")
  timeLimit    Int      @default(30) // minutes
  isPublic     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Creator
  creatorId    String
  creator      User     @relation(fields: [creatorId], references: [id])
  
  // Relations
  interviews   InterviewQuestion[]
  submissions  Submission[]

  @@index([difficulty])
  @@index([category])
  @@index([creatorId])
}

model InterviewQuestion {
  id           String    @id @default(cuid())
  interviewId  String
  questionId   String
  order        Int
  addedAt      DateTime  @default(now())
  
  interview    Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  question     Question  @relation(fields: [questionId], references: [id])

  @@unique([interviewId, questionId])
  @@index([interviewId])
}

// ============================================
// CODE SUBMISSIONS & EXECUTION
// ============================================

model Submission {
  id           String   @id @default(cuid())
  interviewId  String
  questionId   String
  userId       String
  code         String
  language     String
  status       String   @default("PENDING") // PENDING, RUNNING, PASSED, FAILED, ERROR, TIMEOUT
  
  // Execution results
  output       String?
  error        String?
  executionTime Int?    // in milliseconds
  memoryUsed    Int?    // in KB
  testResults   Json?
  
  // AI Analysis
  aiAnalysis    Json?
  
  createdAt    DateTime @default(now())
  
  interview    Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  question     Question  @relation(fields: [questionId], references: [id])
  user         User      @relation(fields: [userId], references: [id])

  @@index([interviewId])
  @@index([userId])
  @@index([questionId])
}

// ============================================
// CODE SNAPSHOTS (for playback)
// ============================================

model CodeSnapshot {
  id           String    @id @default(cuid())
  interviewId  String
  code         String
  language     String
  timestamp    DateTime  @default(now())
  
  interview    Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId, timestamp])
}

// ============================================
// INTERVIEW NOTES & FEEDBACK
// ============================================

model InterviewNote {
  id           String    @id @default(cuid())
  interviewId  String
  userId       String
  content      String
  timestamp    DateTime  @default(now())
  isPrivate    Boolean   @default(true)
  
  interview    Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id])

  @@index([interviewId])
  @@index([userId])
}
